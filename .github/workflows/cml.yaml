name: ML CI/CD with CML (Docker)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  cml-docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Install CML CLI
      - name: Install CML
        run: npm install -g @dvcorg/cml

      # 3. Build Docker image
      - name: Build Docker image
        run: docker build -t house_price_mlops .

      # 4. Train model inside Docker
      - name: Train model
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            house_price_mlops \
            python -m src.train

      # 5. Evaluate model
      - name: Evaluate model
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            house_price_mlops \
            python -m src.evaluate

      # 6. Generate plots
      - name: Generate plots
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            house_price_mlops \
            python -m src.plots

      # 7. Publish plots to CML
      - name: Publish plot images to CML
        env:
          REPO_TOKEN: ${{ secrets.CML_GH_TOKEN }}
        run: |
          mkdir -p reports
          NEW_PRED=$(cml publish metrics/pred_vs_true.png)
          NEW_RES=$(cml publish metrics/residuals.png)
          echo "NEW_PRED_URL=$NEW_PRED" >> reports/links.env
          echo "NEW_RES_URL=$NEW_RES" >> reports/links.env

      # 8. Generate comparison report
      - name: Generate comparison report
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/app \
            -w /app \
            house_price_mlops \
            python -m src.compare

      # 9. Debug - List metrics
      - name: Debug - List metrics
        run: ls -l metrics

      # 10. Post CML comment
      - name: Post CML comment
        env:
          REPO_TOKEN: ${{ secrets.CML_GH_TOKEN }}
        run: |
          cml comment create --publish reports/comparison_report.md
